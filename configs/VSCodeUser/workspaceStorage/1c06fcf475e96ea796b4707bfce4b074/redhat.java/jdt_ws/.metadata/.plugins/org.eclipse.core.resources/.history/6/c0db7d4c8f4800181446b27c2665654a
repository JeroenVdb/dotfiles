package net.persgroep.app.gigyaoidc.web.view;

import net.persgroep.app.gigyaoidc.AbstractIntegrationTest;
import net.persgroep.app.gigyaoidc.service.OidcClientId;
import org.junit.Before;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.thymeleaf.spring4.view.AbstractThymeleafView;

import java.util.Locale;

import static net.persgroep.app.gigyaoidc.web.model.RelyingPartyMother.CLIENT_ID;
import static net.persgroep.app.gigyaoidc.web.model.RelyingPartyMother.VIEW_BASE_PATH;
import static net.persgroep.app.gigyaoidc.web.model.RelyingPartyMother.relyingParty;
import static net.persgroep.app.gigyaoidc.web.model.RelyingPartyMother.relyingPartyWithCustomViews;
import static org.assertj.core.api.Assertions.assertThat;

public class CustomThymeleafViewResolverIT extends AbstractIntegrationTest {

    @Autowired
    private CustomThymeleafViewResolver viewResolver;

    @Autowired
    private OidcClientId oidcClientId;

    @Before
    public void init() {
        clearMongoCollections();
    }

    @Test
    public void testNoClientId() throws Exception {
        relyingPartyCollection.save(relyingParty());
        AbstractThymeleafView view = (AbstractThymeleafView)viewResolver.resolveViewName("login", Locale.getDefault());
        assertThat(view.getTemplateName()).isEqualTo("login");
    }

    @Test
    public void testUnknownClientId() throws Exception {
        oidcClientId.setClientId(CLIENT_ID);
        AbstractThymeleafView view = (AbstractThymeleafView)viewResolver.resolveViewName("login", Locale.getDefault());
        assertThat(view.getTemplateName()).isEqualTo("login");
    }

    @Test
    public void testNoCustomView() throws Exception {
        relyingPartyCollection.save(relyingParty());
        oidcClientId.setClientId(CLIENT_ID);
        AbstractThymeleafView view = (AbstractThymeleafView)viewResolver.resolveViewName("login", Locale.getDefault());
        assertThat(view.getTemplateName()).isEqualTo("login");
    }

    @Test
    public void testCustomView() throws Exception {
        relyingPartyCollection.save(relyingPartyWithCustomViews());
        oidcClientId.setClientId(CLIENT_ID);
        AbstractThymeleafView view = (AbstractThymeleafView)viewResolver.resolveViewName("login", Locale.getDefault());
        assertThat(view.getTemplateName()).isEqualTo(VIEW_BASE_PATH + "login");
    }

}